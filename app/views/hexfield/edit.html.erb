<% content_for :head do %>
<%# TODO: remove: %>
  <%# javascript_import_module_tag "parse5" %>

<%# 
  <script src="/hex/mcp.js" type="module"></script>
  %>
  <script src="/builder/builder-globals.js" type="module"></script>
  <script src="/builder/builder.js" type="module"></script>
  <script src="/builder/builder-attributes.js" type="module"></script>
  <script src="/builder/builder-properties.js" type="module"></script>
  <script src="/builder/builder-trash.js" type="module"></script>
  <script src="/builder/builder-elements.js" type="module"></script>
  <script src="/builder/builder-parser.js" type="module"></script>
  <script src="/hex/files.js" type="module"></script>
  <script src="/hex/tabs.js" type="module"></script>
  <script src="/hex/menubar.js" type="module"></script>

<style>

#header
{
  display: flex;
}

#header > *
{
  flex: 1;
  margin: 0 1rem;
}

#user-div,
#user-div > div
{
  text-align: right;
}

#middle
{
  height: 100%;
  min-height: 0;
  display: flex;
  gap: 1rem;
}

#sidebar
{
  /*width: min-content;*/
  min-width: 20%;
  flex-shrink: 0;
}

#workspace
{
  flex: 1;
  overflow: hidden;
}

/*
TODO: move to hexfield.css
*/
</style>
  
    <link rel="stylesheet" href="/builder/builder.css">
    <link rel="stylesheet" href="/css/ui.css">

<% end %>


<div id="main">

<hex-menubar>
 <% if @user_signed_in %>
    <%= @user.name %>
  <% end %>
</hex-menubar>

<!--
<div id="header">

<h1>Hexfield</h1>

<div id="vis-div" style="text-align: center; display: none">
  Visibility:
  <select id="vis-sel">
    <option value="0">Private</option>
    <option value="1">Public</option>
  </select>
</div>

<div id="user-div">
  <%# if @user.present? %>
  <% if @user_signed_in %>
    <div>User: <%= @user.name %></div>
    <div>
      <%= link_to "Sign out", "/users/sign_out", data: { turbo_method: :delete } %> 
    </div>
  <% end %>
</div>

</div>
-->

<div id="middle">

<div id="sidebar">
  <hex-tabs no-tabs id="sidebar-tabs">
    <hex-tabs>
      <div tab="One">One</div>
      <div tab="Two">Two</div>
    </hex-tabs>
    <builder-bank style="width: 100%; height: 100%;"></builder-bank>
  </hex-tabs>
</div>

<hex-tabs id="workspace" disabled>
  <div tab="Text" style="height: 100%;">
    <div id="body"></div>
    <script>
      const tabs = document.querySelector("#sidebar-tabs");
      let scriptPar = document.currentScript.parentElement;
      scriptPar.onshow =
        mcp =>
        {
          console.log("show code!");
          tabs.selectedIndex = 0;
        };
    </script>
  </div>
  <div tab="Blocks" style="height: 100%;">
    <div id="code">
      <div
        class="dropzone"
        ondrop="builder_globals.handlers.drop(event)"
        ondragover="builder_globals.handlers.dragover(event)"
        ondragleave="builder_globals.handlers.dragleave(event)">
      </div>
    </div>
    <script>
      scriptPar = document.currentScript.parentElement;
      scriptPar.onshow =
        mcp =>
        {
          console.log("show blocks!");
          tabs.selectedIndex = 1;

          const code = mcp.file_data[mcp.current_file_name];
          let bout = builder_globals.load_code(code);
          document.querySelector("#code").innerHTML = bout.innerHTML;

          builder_globals.blocks_visited = true;
        };
    </script>
  </div>
  <div tab="Preview" style="height: 100%;">
    <style>
#render
{
  width: 100%;
  height: 100%;
  border-width: 0;
  display: block;
}
    </style>
    <iframe id="render"></iframe>
    <script>
      const render = document.querySelector("#render");
      scriptPar = document.currentScript.parentElement;
      scriptPar.onshow =
        () =>
        {
          console.log("refresh preview");
          //render.contentWindow.location.reload();
          // above changed to:
          render.contentWindow?.location.reload();
          tabs.selectedIndex = 0;
        };
    </script>
  </div>
</hex-tabs>

</div>


<div id="footer">
  <hex-files></hex-files>
</div>

</div>

<script type="module">
import * as mcp from "/hex/mcp.js";
import {minimalSetup} from "codemirror"
import {EditorView, keymap, lineNumbers} from "@codemirror/view"
import {syntaxTree} from "@codemirror/language"
import {html} from "@codemirror/lang-html"
import {indentWithTab} from "@codemirror/commands"

/* Code Miror stuff */

const fixedHeightEditor = EditorView.theme({
  "&": {height: "100%"},
  ".cm-scroller": {overflow: "auto"}
});

//body = document.querySelector("hex-tabs").shadowRoot.querySelector("#root");
let body = document.querySelector("#body");

let deb_upd; // debounce editor update callback

// the root parameter is necessary below
// I think because the element "seems" to be in a custom element,
// but is not in its shadowRoot.
const view = new EditorView({
  parent: body,
  root: document,
  extensions: [
    minimalSetup,
    keymap.of([indentWithTab]),
    fixedHeightEditor,
    lineNumbers(),
    html({autoCloseTags: false}),
    EditorView.updateListener.of(
      v =>
      {
        if (v.docChanged)
        {
          if (deb_upd) clearTimeout(deb_upd);
          deb_upd = setTimeout(
            () =>
            {
                const code = view.state.doc.toString();
                mcp.file_data[mcp.current_file_name] = code;
                mcp.fireEvent(mcp.events.update_file_data);
            },
            500 // delay
          );
        }
      })
  ]
});

window.cm = view; // TODO: remove after debugging

mcp.register_html_editor(view);

mcp.regHexEvent(mcp.events.load_code_file_text,
  file =>
  {
    //render.contentWindow.location = `/web/${file}`;
    // above changed to:
    render.src = `/web/${file}`;
  }
);

/* Builder mutation observer */

// Select the node that will be observed for mutations
const targetNode = document.querySelector("#code");

// Options for the observer (which mutations to observe)
const config = { childList: true, subtree: true, characterData: true };

let deb_obs;

// Callback function to execute when mutations are observed
const obs_func = (mutationList, observer) => {
  console.log("builder blocks changed", mutationList);
  if (deb_obs) clearTimeout(deb_obs);
  deb_obs = setTimeout(
    () =>
    {
      const code = builder_globals.render_code();
      // TODO: maybe: move this next line into mcp.update_html_code_editor
      mcp.file_data[mcp.current_file_name] = code;
      mcp.update_html_code_editor(code);
    },
    500
  )
};

// Create an observer instance linked to the callback function
const observer = new MutationObserver(obs_func);

// Start observing the target node for configured mutations
observer.observe(targetNode, config);

/* Project Visibility control */

const vis_sel = document.querySelector("#vis-sel");
const params = new URLSearchParams(document.location.search);
vis_sel.selectedIndex = params.get("project[visibility]");
vis_sel.addEventListener(
  "change",
  () =>
  {
    const sp = new URLSearchParams(document.location.search);
    sp.set("project[visibility]", vis_sel.selectedIndex);
    window.history.replaceState(null, "", `edit?${sp}`);
    mcp.update_project();
  }
);
const vis_div = document.querySelector("#vis-div");
vis_div.style.display = "initial";

/* Main Tabs enabled? */

// update workspace tabs disabled-or-not status
const update_tabs =
  () =>
  {
    console.log("setting disabled", mcp.files[0]);
    if (mcp.files[0].length > 0)
      document.querySelector("#workspace").removeAttribute("disabled");
    else
      document.querySelector("#workspace").setAttribute("disabled", "");
  };
mcp.regHexEvent(mcp.events.files_loaded, update_tabs);
mcp.regHexEvent(mcp.events.file_created, update_tabs);
</script>